# Домашнее задание 2 (Вариант B)

## 1. Структура проекта

```
.
├── src/                 # исходный код
│   ├── main.py          # основной пайплайн
│   ├── flow_utils.py    # расчёт оптического потока
│   ├── mask_utils.py    # функции переноса, сглаживания, морфологии
│   ├── io_utils.py      # загрузка видео и маски
│   |── vis_utils.py     # визуализация (overlay, графики)
│   └── vis.ipynd        # ноутбук с подробными выводами и визуализацией 
├── input_resized.mp4    # исходное видео 
├── mask0_resized.png    # исходная маска
├── output/              # результаты
│   ├── baseline/        # исходная маска без переноса
│   ├── forward/         # прямой перенос
│   ├── forward_smooth/  # перенос + сглаживание
│   ├── forward_smooth_morph/ # перенос + сглаживание + морфология
│   └── bidirectional/   # перенос + сглаживание + backward pass
└── README.md
```

---

## 2. Краткая структура пайплайна

1. **Загрузка видео и исходной маски**
   Маска задаётся вручную на первом кадре.

2. **Прямой перенос маски (Forward)**

   * Вычисляется плотный оптический поток Farnebäck между соседними кадрами.
   * Маска переносится на следующий кадр с помощью `cv2.remap`.

3. **Сглаживание маски (Temporal smoothing)**

   * Используется экспоненциальное сглаживание: `mask_smooth = beta*mask_prev_smooth + (1-beta)*mask_warped`.
   * Морфология (closing/opening) помогает убрать разрывы и мелкие шумы.

4. **Обратный проход (Backward)**

   * Дополнительно уточняет маски, используя информацию из будущих кадров (bidirectional pass).

5. **Сравнение вариантов**

   * Baseline (маска только на кадре 0)
   * Forward pass
   * Forward + smoothing
   * Forward + smoothing + morph
   * Bidirectional smoothing

---

## 3. Использованные модели и параметры

* **Оптический поток:** Farnebäck (`cv2.calcOpticalFlowFarneback`)

  * pyr_scale=0.5, levels=2, winsize=10, iterations=3, poly_n=5, poly_sigma=1.2
* **Сглаживание:** `beta = 0.3`
* **Морфология:** kernel 3x3 (closing + opening)

Для решения задачи Video Object Segmentation был выбран метод переноса маски на основе **плотного оптического потока** (Farnebäck), так как он:

* не требует обучения и дополнительной разметки;
* позволяет получить вектор смещения для каждого пикселя;
* хорошо подходит для демонстрации базовых принципов переноса информации во времени.

В качестве базового варианта был использован **baseline без переноса**, что позволяет оценить вклад временной информации и служит точкой отсчёта для сравнения всех последующих методов.

Для уменьшения мерцания масок применено **экспоненциальное временное сглаживание**, которое является простым и вычислительно дешёвым способом стабилизации последовательных предсказаний без использования дополнительных моделей.

**Двустороннее сглаживание (forward + backward)** было добавлено как попытка использовать информацию из будущих кадров для коррекции ошибок переноса. Такой подход широко используется в задачах временной фильтрации, однако в данном случае его эффективность ограничена накоплением ошибок на поздних кадрах.

Для улучшения визуальной целостности масок использована **морфологическая постобработка**, позволяющая закрывать мелкие разрывы и соединять близкие области, что особенно важно при ошибках оптического потока на границах объекта.

Выбранные методы образуют последовательность от простых к более сложным и позволяют наглядно продемонстрировать влияние каждого этапа обработки на стабильность и качество сегментации.


---

## 4. Визуализация и графики

* **Видео с наложенными масками** для всех вариантов сохранены в папках `output/...`.
* **Покадровые маски** сохранены в папках `output/...`.
* **Графики стабильности:** в ноутбуке

  * Temporal IoU между кадрами
  * Площадь маски (число пикселей)
* **Примеры корректного переноса и провалов:**

  * Ранние кадры: маска точно повторяет объект
  * Поздние кадры: смещения, разрывы, ghosting

---

## 5. Основные наблюдения и инженерный вывод

1. **Качество маски уменьшается с течением времени**

   * На первых кадрах маска полностью совпадает с объектом.
   * Чем дальше от начала, тем больше ошибок: отставание, разрывы, ghosting.

2. **Влияние методов сглаживания и постобработки**

   * Экспоненциальное временное сглаживание снижает мерцание маски между кадрами, однако приводит к запаздыванию относительно движения объекта.  Дополнительно наблюдается эффект «следа» (ghosting): маска частично сохраняется в предыдущем положении и медленно догоняет объект.

   * Двустороннее сглаживание (bidirectional smoothing) не даёт заметного улучшения качества в данной задаче. Это связано с тем, что ошибки переноса на поздних кадрах накапливаются, и маски будущих кадров часто оказываются хуже, чем маски предыдущих, поэтому обратный проход не может эффективно скорректировать результат.
   * Морфологическая постобработка (closing / opening) помогает соединить разорванные части маски и закрыть мелкие дыры, улучшая визуальную целостность объекта, однако не устраняет глобальные смещения и накопленные ошибки переноса.

3. **Эффективность переноса маски**

   * Работает хорошо для коротких последовательностей и медленного движения.
   * Быстрое движение, окклюзии и длительные видео приводят к накоплению ошибок.

4. **Технический вывод**

   * Основные проблемы: уменьшение размера маски, разрывы, эффект "следа".
   * Перенос маски улучшает качество в начале видео и на медленно движущихся объектах.

